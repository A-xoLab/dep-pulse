import { beforeEach, describe, expect, it, vi } from 'vitest';
import type * as vscode from 'vscode';
import type { Dependency, Vulnerability, VulnerabilityClient, VulnerabilitySource } from '../types';
import type { RequestQueue } from '../utils/RequestQueue';
import { VulnerabilityAggregator } from './VulnerabilityAggregator';

// Mock output channel
const createMockOutputChannel = (): vscode.OutputChannel => ({
  name: 'test',
  append: vi.fn(),
  appendLine: vi.fn(),
  replace: vi.fn(),
  clear: vi.fn(),
  show: vi.fn(),
  hide: vi.fn(),
  dispose: vi.fn(),
});

// Mock request queue
const createMockRequestQueue = (): RequestQueue =>
  ({
    enqueue: vi.fn().mockImplementation((fn) => fn()),
    clear: vi.fn(),
    getQueueSize: vi.fn().mockReturnValue(0),
    getActiveCount: vi.fn().mockReturnValue(0),
  }) as unknown as RequestQueue;

// Mock vulnerability client
const createMockClient = (vulnerabilities: Map<string, Vulnerability[]>): VulnerabilityClient => ({
  getVulnerabilities: vi.fn().mockImplementation(async (packageName: string) => {
    return vulnerabilities.get(packageName) || [];
  }),
  getBatchVulnerabilities: vi.fn().mockResolvedValue(vulnerabilities),
});

describe('VulnerabilityAggregator - Batch Operations', () => {
  let aggregator: VulnerabilityAggregator;
  let mockOutputChannel: vscode.OutputChannel;
  let mockRequestQueue: RequestQueue;

  beforeEach(() => {
    mockOutputChannel = createMockOutputChannel();
    mockRequestQueue = createMockRequestQueue();
  });

  describe('getBatchAggregatedVulnerabilities', () => {
    it('should aggregate vulnerabilities from GitHub', async () => {
      const deps: Dependency[] = [
        { name: 'express', version: '4.17.1', versionConstraint: '4.17.1', isDev: false },
      ];

      const githubVulns = new Map([
        [
          'express',
          [
            {
              id: 'CVE-2021-1234',
              title: 'GitHub Vuln 1',
              severity: 'high',
              affectedVersions: '< 4.17.2',
              description: 'Test vulnerability 1',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
            {
              id: 'CVE-2021-5678',
              title: 'GitHub Vuln 2',
              severity: 'medium',
              affectedVersions: '< 4.17.1',
              description: 'Test vulnerability 2',
              references: [],
              publishedDate: new Date('2021-02-01'),
              lastModifiedDate: new Date('2021-02-02'),
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['github', createMockClient(githubVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'github',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      expect(result.size).toBe(1);
      expect(result.has('express')).toBe(true);
      const vulns = result.get('express');
      expect(vulns).toBeDefined();
      expect(vulns).toHaveLength(2);
      expect(vulns?.[0].sources).toContain('github');
      expect(vulns?.[1].sources).toContain('github');
    });

    it('should handle multiple packages', async () => {
      const deps: Dependency[] = [
        { name: 'express', version: '4.17.1', versionConstraint: '4.17.1', isDev: false },
        { name: 'lodash', version: '4.17.20', versionConstraint: '4.17.20', isDev: false },
        { name: 'axios', version: '0.21.1', versionConstraint: '0.21.1', isDev: false },
      ];

      const githubVulns = new Map([
        [
          'express',
          [
            {
              id: 'CVE-2021-1111',
              title: 'Express Vuln',
              severity: 'high',
              affectedVersions: '< 4.17.2',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
        [
          'lodash',
          [
            {
              id: 'CVE-2021-2222',
              title: 'Lodash Vuln',
              severity: 'medium',
              affectedVersions: '< 4.17.21',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
        ['axios', []],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['github', createMockClient(githubVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'github',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      expect(result.size).toBe(3);
      expect(result.get('express')).toHaveLength(1);
      expect(result.get('lodash')).toHaveLength(1);
      expect(result.get('axios')).toHaveLength(0);
    });
  });

  describe('OSV and GitHub aggregation', () => {
    it('should aggregate vulnerabilities from both OSV and GitHub', async () => {
      const deps: Dependency[] = [
        { name: 'lodash', version: '4.17.20', versionConstraint: '4.17.20', isDev: false },
      ];

      const osvVulns = new Map([
        [
          'lodash',
          [
            {
              id: 'CVE-2021-23337',
              title: 'OSV Vulnerability',
              severity: 'high',
              affectedVersions: '< 4.17.21',
              description: 'OSV test vulnerability',
              references: ['https://osv.dev/vulnerability/CVE-2021-23337'],
              publishedDate: new Date('2021-03-01'),
              lastModifiedDate: new Date('2021-03-02'),
              cvssScore: 7.5,
              cvssVersion: '3.1',
            },
          ],
        ],
      ]);

      const githubVulns = new Map([
        [
          'lodash',
          [
            {
              id: 'GHSA-xxxx-xxxx-xxxx',
              title: 'GitHub Vulnerability',
              severity: 'critical',
              affectedVersions: '< 4.17.21',
              description: 'GitHub test vulnerability',
              references: ['https://github.com/advisories/GHSA-xxxx'],
              publishedDate: new Date('2021-03-01'),
              lastModifiedDate: new Date('2021-03-02'),
              cvssScore: 9.0,
              cvssVersion: '3.1',
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(osvVulns)],
        ['github', createMockClient(githubVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
        'github',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      expect(result.size).toBe(1);
      const vulns = result.get('lodash');
      expect(vulns).toBeDefined();
      expect(vulns?.length).toBeGreaterThanOrEqual(1);
    });

    it('should deduplicate vulnerabilities by ID', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const osvVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
      ]);

      const githubVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234', // Same ID
              title: 'Test Vulnerability (GitHub)',
              severity: 'critical',
              affectedVersions: '< 1.0.1',
              description: 'Test from GitHub',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(osvVulns)],
        ['github', createMockClient(githubVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
        'github',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      const vulns = result.get('test-package');
      expect(vulns).toBeDefined();
      expect(vulns?.length).toBe(1); // Should be deduplicated
      expect(vulns?.[0].sources).toContain('osv');
      expect(vulns?.[0].sources).toContain('github');
    });

    it('should merge affectedVersions when deduplicating vulnerabilities with same ID', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const githubVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'GHSA-9qr9-h5gf-34mp',
              title: 'Critical Vulnerability',
              severity: 'critical',
              affectedVersions: '>= 14.3.0-canary.77, < 15.0.5', // Range 1
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
            {
              id: 'GHSA-9qr9-h5gf-34mp', // Same ID
              title: 'Critical Vulnerability',
              severity: 'critical',
              affectedVersions: '>= 15.2.0-canary.0, < 15.2.6', // Range 2
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['github', createMockClient(githubVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'github',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      const vulns = result.get('test-package');
      expect(vulns).toBeDefined();
      expect(vulns?.length).toBe(1); // Should be deduplicated

      const aggregatedVuln = vulns?.[0];
      expect(aggregatedVuln?.affectedVersions).toContain('>= 14.3.0-canary.77, < 15.0.5');
      expect(aggregatedVuln?.affectedVersions).toContain('>= 15.2.0-canary.0, < 15.2.6');
      expect(aggregatedVuln?.affectedVersions).toContain('||');
    });

    it('should select highest severity when deduplicating', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const osvVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
      ]);

      const githubVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'critical',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(osvVulns)],
        ['github', createMockClient(githubVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
        'github',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      const vulns = result.get('test-package');
      expect(vulns?.[0].highestSeverity).toBe('critical');
      expect(vulns?.[0].severity).toBe('critical');
    });

    it('should merge affectedVersions from different sources', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const osvVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.0', // Range 1
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
      ]);

      const githubVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234', // Same ID
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '>= 1.0.0 < 2.0.0', // Range 2
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(osvVulns)],
        ['github', createMockClient(githubVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
        'github',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      const vulns = result.get('test-package');
      expect(vulns).toBeDefined();
      expect(vulns?.length).toBe(1);

      const aggregatedVuln = vulns?.[0];
      expect(aggregatedVuln?.affectedVersions).toContain('< 1.0.0');
      expect(aggregatedVuln?.affectedVersions).toContain('>= 1.0.0 < 2.0.0');
      expect(aggregatedVuln?.affectedVersions).toContain('||');
    });
  });

  describe('CVSS score handling', () => {
    it('should prefer higher CVSS version when merging', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const osvVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
              cvssScore: 7.5,
              cvssVersion: '3.1',
            },
          ],
        ],
      ]);

      const githubVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
              cvssScore: 8.0,
              cvssVersion: '4.0',
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(osvVulns)],
        ['github', createMockClient(githubVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
        'github',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      const vulns = result.get('test-package');
      expect(vulns?.[0].cvssVersion).toBe('4.0');
      expect(vulns?.[0].cvssScore).toBe(8.0);
    });

    it('should prefer higher CVSS score when versions are equal', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const osvVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
              cvssScore: 7.5,
              cvssVersion: '3.1',
            },
          ],
        ],
      ]);

      const githubVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
              cvssScore: 9.0,
              cvssVersion: '3.1',
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(osvVulns)],
        ['github', createMockClient(githubVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
        'github',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      const vulns = result.get('test-package');
      expect(vulns?.[0].cvssScore).toBe(9.0);
    });

    it('should handle missing CVSS scores', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const osvVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
              // No CVSS score
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(osvVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      const vulns = result.get('test-package');
      expect(vulns?.[0]).toBeDefined();
      expect(vulns?.[0].cvssScore).toBeUndefined();
    });
  });

  describe('Error handling', () => {
    it('should handle OSV client failure and fallback to GitHub', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const osvClient = {
        getBatchVulnerabilities: vi.fn().mockRejectedValue(new Error('OSV API error')),
        getVulnerabilities: vi.fn(),
      } as unknown as VulnerabilityClient;

      const githubVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'GHSA-xxxx',
              title: 'GitHub Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', osvClient],
        ['github', createMockClient(githubVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
        'github',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      expect(result.size).toBe(1);
      const vulns = result.get('test-package');
      expect(vulns).toBeDefined();
      expect(vulns?.[0].sources).toContain('github');
    });

    it('should handle GitHub client failure when OSV succeeds', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const osvVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'OSV Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
      ]);

      const githubClient = {
        getBatchVulnerabilities: vi.fn().mockRejectedValue(new Error('GitHub API error')),
        getVulnerabilities: vi.fn(),
      } as unknown as VulnerabilityClient;

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(osvVulns)],
        ['github', githubClient],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
        'github',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      expect(result.size).toBe(1);
      const vulns = result.get('test-package');
      expect(vulns).toBeDefined();
      expect(vulns?.[0].sources).toContain('osv');
    });

    it('should handle both clients failing gracefully', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const osvClient = {
        getBatchVulnerabilities: vi.fn().mockRejectedValue(new Error('OSV API error')),
        getVulnerabilities: vi.fn(),
      } as unknown as VulnerabilityClient;

      const githubClient = {
        getBatchVulnerabilities: vi.fn().mockRejectedValue(new Error('GitHub API error')),
        getVulnerabilities: vi.fn(),
      } as unknown as VulnerabilityClient;

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', osvClient],
        ['github', githubClient],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
        'github',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      expect(result.size).toBe(1);
      const vulns = result.get('test-package');
      expect(vulns).toBeDefined();
      expect(vulns).toHaveLength(0);
    });

    it('should handle missing OSV client', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
      ]);

      await expect(aggregator.getBatchAggregatedVulnerabilities(deps)).rejects.toThrow(
        'OSV client not available'
      );
    });

    it('should handle missing GitHub client when needed', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const osvClient = {
        getBatchVulnerabilities: vi.fn().mockResolvedValue(new Map()),
        getVulnerabilities: vi.fn(),
      } as unknown as VulnerabilityClient;

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([['osv', osvClient]]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
        'github',
      ]);

      // Should not throw, but log warning
      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);
      expect(result.size).toBe(1);
    });
  });

  describe('Empty result handling', () => {
    it('should handle empty vulnerability lists', async () => {
      const deps: Dependency[] = [
        { name: 'safe-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const osvVulns = new Map([['safe-package', []]]);
      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(osvVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      expect(result.size).toBe(1);
      expect(result.get('safe-package')).toHaveLength(0);
    });

    it('should handle empty OSV results and fallback to GitHub', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const osvVulns = new Map([['test-package', []]]);

      const githubVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'GHSA-xxxx',
              title: 'GitHub Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(osvVulns)],
        ['github', createMockClient(githubVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
        'github',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      expect(result.size).toBe(1);
      const vulns = result.get('test-package');
      expect(vulns).toBeDefined();
      expect(vulns?.[0].sources).toContain('github');
    });
  });

  describe('Large batch processing', () => {
    it('should handle 100+ dependencies efficiently', async () => {
      const deps: Dependency[] = Array.from({ length: 150 }, (_, i) => ({
        name: `package-${i}`,
        version: '1.0.0',
        versionConstraint: '1.0.0',
        isDev: false,
      }));

      const osvVulns = new Map(
        deps.map((dep) => [
          dep.name,
          dep.name === 'package-0'
            ? [
                {
                  id: `CVE-2021-${dep.name}`,
                  title: 'Test Vulnerability',
                  severity: 'high',
                  affectedVersions: '< 1.0.1',
                  description: 'Test',
                  references: [],
                  publishedDate: new Date('2021-01-01'),
                  lastModifiedDate: new Date('2021-01-02'),
                },
              ]
            : [],
        ])
      );

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(osvVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
      ]);

      const startTime = Date.now();
      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);
      const duration = Date.now() - startTime;

      expect(result.size).toBe(150);
      expect(duration).toBeLessThan(5000); // Should complete quickly with mocks
    });
  });

  describe('Primary source configuration', () => {
    it('should use OSV as primary source by default', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const osvVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'OSV Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(osvVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      expect(result.size).toBe(1);
      const vulns = result.get('test-package');
      expect(vulns?.[0].sources).toContain('osv');
    });

    it('should use GitHub as primary source when configured', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const githubVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'GHSA-xxxx',
              title: 'GitHub Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['github', createMockClient(githubVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(
        clients,
        mockRequestQueue,
        mockOutputChannel,
        ['github'],
        'github'
      );

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      expect(result.size).toBe(1);
      const vulns = result.get('test-package');
      expect(vulns?.[0].sources).toContain('github');
    });

    it('should allow changing primary source', () => {
      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([]);
      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, []);

      aggregator.setPrimarySource('github');
      expect((aggregator as unknown as { primarySource: string }).primarySource).toBe('github');
    });
  });

  describe('Source configuration', () => {
    it('should configure active sources', () => {
      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(new Map())],
        ['github', createMockClient(new Map())],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
      ]);

      aggregator.configureSources(['github']);

      expect((aggregator as unknown as { activeSources: string[] }).activeSources).toContain(
        'github'
      );
      expect((aggregator as unknown as { activeSources: string[] }).activeSources).not.toContain(
        'osv'
      );
    });

    it('should use all available sources when empty array provided', () => {
      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(new Map())],
        ['github', createMockClient(new Map())],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
      ]);

      aggregator.configureSources([]);

      expect(
        (aggregator as unknown as { activeSources: string[] }).activeSources.length
      ).toBeGreaterThan(0);
    });

    it('should filter out sources without clients', () => {
      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(new Map())],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
      ]);

      aggregator.configureSources(['osv', 'github']);

      expect((aggregator as unknown as { activeSources: string[] }).activeSources).toContain('osv');
      expect((aggregator as unknown as { activeSources: string[] }).activeSources).not.toContain(
        'github'
      );
    });
  });

  describe('Connection pool optimization', () => {
    it('should optimize connection pool when OSV client supports it', () => {
      const osvClient = {
        optimizeConnectionPool: vi.fn(),
        getBatchVulnerabilities: vi.fn(),
      } as unknown as VulnerabilityClient;

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([['osv', osvClient]]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
      ]);

      aggregator.optimizeConnectionPool(500);

      expect(
        (osvClient as unknown as { optimizeConnectionPool: unknown }).optimizeConnectionPool
      ).toHaveBeenCalledWith(500);
    });

    it('should not throw when OSV client does not support optimization', () => {
      const osvClient = {
        getBatchVulnerabilities: vi.fn(),
        // No optimizeConnectionPool method
      } as unknown as VulnerabilityClient;

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([['osv', osvClient]]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
      ]);

      expect(() => aggregator.optimizeConnectionPool(500)).not.toThrow();
    });
  });

  describe('Vulnerability merging', () => {
    it('should merge references from multiple sources', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const osvVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: ['https://osv.dev/vulnerability/CVE-2021-1234'],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
      ]);

      const githubVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: ['https://github.com/advisories/GHSA-xxxx'],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(osvVulns)],
        ['github', createMockClient(githubVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
        'github',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      const vulns = result.get('test-package');
      expect(vulns?.[0].references.length).toBeGreaterThanOrEqual(1);
    });

    it('should merge CWE IDs from multiple sources', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const osvVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
              cweIds: ['CWE-79'],
            },
          ],
        ],
      ]);

      const githubVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
              cweIds: ['CWE-89'],
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(osvVulns)],
        ['github', createMockClient(githubVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
        'github',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      const vulns = result.get('test-package');
      expect(vulns?.[0].cweIds).toContain('CWE-79');
      expect(vulns?.[0].cweIds).toContain('CWE-89');
    });

    it('should use earliest published date when merging', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const osvVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-02-01'),
              lastModifiedDate: new Date('2021-02-02'),
            },
          ],
        ],
      ]);

      const githubVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'), // Earlier date
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(osvVulns)],
        ['github', createMockClient(githubVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
        'github',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      const vulns = result.get('test-package');
      expect(vulns?.[0].publishedDate).toEqual(new Date('2021-01-01'));
    });

    it('should use latest modified date when merging', async () => {
      const deps: Dependency[] = [
        { name: 'test-package', version: '1.0.0', versionConstraint: '1.0.0', isDev: false },
      ];

      const osvVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-03-01'), // Later date
            },
          ],
        ],
      ]);

      const githubVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-02-01'),
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(osvVulns)],
        ['github', createMockClient(githubVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
        'github',
      ]);

      const result = await aggregator.getBatchAggregatedVulnerabilities(deps);

      const vulns = result.get('test-package');
      expect(vulns?.[0].lastModifiedDate).toEqual(new Date('2021-03-01'));
    });
  });

  describe('Individual package queries', () => {
    it('should aggregate vulnerabilities for single package', async () => {
      const osvVulns = new Map([
        [
          'test-package',
          [
            {
              id: 'CVE-2021-1234',
              title: 'Test Vulnerability',
              severity: 'high',
              affectedVersions: '< 1.0.1',
              description: 'Test',
              references: [],
              publishedDate: new Date('2021-01-01'),
              lastModifiedDate: new Date('2021-01-02'),
            },
          ],
        ],
      ]);

      const clients = new Map<VulnerabilitySource, VulnerabilityClient>([
        ['osv', createMockClient(osvVulns)],
      ]);

      aggregator = new VulnerabilityAggregator(clients, mockRequestQueue, mockOutputChannel, [
        'osv',
      ]);

      const result = await aggregator.getAggregatedVulnerabilities('test-package', '1.0.0');

      expect(result).toBeDefined();
      expect(result.length).toBe(1);
      expect(result[0].id).toBe('CVE-2021-1234');
    });
  });
});
